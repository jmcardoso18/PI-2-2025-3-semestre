{% extends 'core/base_dashboard.html' %}

{% block content %}
    <div class="flex flex-col md:flex-row md:items-end justify-between gap-6 mb-8">
        <div>
            <p class="text-xs font-semibold tracking-[0.25em] uppercase text-neutral-500 mb-2">
                Área da Equipe
            </p>
            <h1 class="font-display text-3xl sm:text-4xl text-neutral-900 mb-1">
                {{ evento.nome }}
            </h1>
            <p class="text-sm text-neutral-600 flex items-center gap-2">
                <span>{{ evento.data|date:"d/m/Y" }}</span>
                <span class="w-1 h-1 bg-neutral-400 rounded-full"></span>
                <span>{{ evento.local }}</span>
            </p>
        </div>

        <div class="flex gap-4">
            <div class="text-right">
                <p class="text-xs text-neutral-500 uppercase tracking-wide font-semibold">Convidados</p>
                <p class="text-2xl font-display font-bold text-neutral-900">{{ convidados.count }}</p>
            </div>
            <div class="w-px bg-neutral-300"></div>
            <div class="text-right">
                <p class="text-xs text-neutral-500 uppercase tracking-wide font-semibold">Atividades</p>
                <p class="text-2xl font-display font-bold text-neutral-900">{{ atividades.count }}</p>
            </div>
        </div>
    </div>

    <div class="grid gap-8 lg:grid-cols-[1fr_1.5fr] items-start">
        
        <section class="space-y-6">
            <div class="rounded-2xl border border-neutral-200 bg-white p-6 shadow-sm">
                <div class="flex justify-between items-center mb-6 border-b border-neutral-100 pb-2">
                    <h2 class="text-sm font-semibold tracking-wide text-neutral-700 uppercase">
                        Cronograma do Dia
                    </h2>
                    <span class="text-xs text-neutral-400">Tempo Real</span>
                </div>

                <div class="space-y-2 relative pl-4 border-l-2 border-neutral-100 ml-2">
                    {% for atividade in atividades %}
                    <div class="group relative pl-6 pb-2">
                        <div id="dot-{{ atividade.id }}" class="absolute -left-[23px] top-1 w-3 h-3 rounded-full border-2 border-white shadow-sm transition-colors
                            {% if atividade.feito %}bg-emerald-500 ring-emerald-200{% else %}bg-neutral-300 ring-neutral-200{% endif %} ring-2">
                        </div>

                        <div class="flex items-start justify-between gap-4 p-3 rounded-xl border border-neutral-100 bg-neutral-50/50 hover:bg-white hover:shadow-sm transition">
                            <div>
                                <span class="text-xs font-bold text-neutral-500 block mb-0.5">{{ atividade.horario|time:"H:i" }}</span>
                                <p id="text-{{ atividade.id }}" class="font-medium text-neutral-900 text-sm transition {% if atividade.feito %}line-through text-neutral-400{% endif %}">
                                    {{ atividade.nome }}
                                </p>
                            </div>

                            <button onclick="toggleAtividade({{ atividade.id }})" id="btn-{{ atividade.id }}"
                                class="flex h-8 w-8 items-center justify-center rounded-full border transition hover:scale-105 active:scale-95
                                {% if atividade.feito %}border-emerald-500 bg-emerald-50 text-emerald-600{% else %}border-neutral-300 bg-white text-neutral-400 hover:border-black hover:text-black{% endif %}">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="3">
                                    <path stroke-linecap="round" stroke-linejoin="round" d="M5 13l4 4L19 7" />
                                </svg>
                            </button>
                        </div>
                    </div>
                    {% empty %}
                    <p class="text-sm text-neutral-500 italic pl-6">Nenhuma atividade programada.</p>
                    {% endfor %}
                </div>
            </div>
        </section>

        <section class="space-y-6">
            <div class="rounded-2xl border border-neutral-200 bg-white p-6 shadow-sm">
                
                <div class="flex flex-col sm:flex-row sm:items-center justify-between gap-4 mb-6 border-b border-neutral-100 pb-4">
                    <h2 class="text-sm font-semibold tracking-wide text-neutral-700 uppercase">
                        Lista de Presença
                    </h2>
                    
                    <div class="relative w-full sm:w-64">
                        <input type="text" id="search-guest" onkeyup="filterGuests()" placeholder="Buscar convidado..." 
                            class="w-full pl-9 pr-4 py-2 rounded-lg border border-neutral-300 text-sm focus:border-black focus:ring-black shadow-sm transition">
                        <svg class="w-4 h-4 absolute left-3 top-2.5 text-neutral-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path></svg>
                    </div>
                </div>

                <div class="overflow-y-auto max-h-[600px] pr-2">
                    <table class="w-full text-left text-sm text-neutral-600" id="guest-table">
                        <thead class="bg-neutral-50 text-xs uppercase text-neutral-500 font-semibold sticky top-0 z-10">
                            <tr>
                                <th class="px-4 py-3 rounded-l-lg">Nome</th>
                                <th class="px-4 py-3 text-center">Acomp.</th>
                                <th class="px-4 py-3 text-center rounded-r-lg">Status</th>
                            </tr>
                        </thead>
                        <tbody class="divide-y divide-neutral-100">
                            {% for convidado in convidados %}
                            <tr class="guest-row hover:bg-neutral-50 transition group">
                                <td class="px-4 py-3 font-medium text-neutral-900">
                                    {{ convidado.nome }}
                                </td>
                                <td class="px-4 py-3 text-center text-neutral-400 font-mono">
                                    +{{ convidado.acompanhantes }}
                                </td>
                                <td class="px-4 py-3 text-center">
                                    <span class="inline-flex items-center rounded-full px-2.5 py-0.5 text-[10px] font-bold uppercase tracking-wide
                                    {% if convidado.status == 'Confirmado' %}bg-emerald-100 text-emerald-800
                                    {% elif convidado.status == 'Recusado' %}bg-red-100 text-red-800
                                    {% else %}bg-amber-100 text-amber-800{% endif %}">
                                        {{ convidado.status }}
                                    </span>
                                </td>
                            </tr>
                            {% empty %}
                            <tr><td colspan="3" class="p-6 text-center text-neutral-500">Lista vazia.</td></tr>
                            {% endfor %}
                        </tbody>
                    </table>
                    <p id="no-results" class="hidden text-center py-8 text-sm text-neutral-400">Nenhum convidado encontrado.</p>
                </div>
            </div>
        </section>

    </div>
{% endblock %}

{% block scripts %}
<script>
    // 1. Alternar Status da Atividade (Checklist)
    function toggleAtividade(id) {
        fetch(`/api/toggle-atividade/${id}/`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
        })
        .then(response => response.json())
        .then(data => {
            if(data.status === 'sucesso') {
                const text = document.getElementById(`text-${id}`);
                const btn = document.getElementById(`btn-${id}`);
                const dot = document.getElementById(`dot-${id}`);

                if(data.feito) {
                    // Estilo FEITO
                    text.classList.add('line-through', 'text-neutral-400');
                    btn.classList.remove('border-neutral-300', 'bg-white', 'text-neutral-400', 'hover:border-black', 'hover:text-black');
                    btn.classList.add('border-emerald-500', 'bg-emerald-50', 'text-emerald-600');
                    dot.classList.remove('bg-neutral-300', 'ring-neutral-200');
                    dot.classList.add('bg-emerald-500', 'ring-emerald-200');
                } else {
                    // Estilo PENDENTE
                    text.classList.remove('line-through', 'text-neutral-400');
                    btn.classList.remove('border-emerald-500', 'bg-emerald-50', 'text-emerald-600');
                    btn.classList.add('border-neutral-300', 'bg-white', 'text-neutral-400', 'hover:border-black', 'hover:text-black');
                    dot.classList.remove('bg-emerald-500', 'ring-emerald-200');
                    dot.classList.add('bg-neutral-300', 'ring-neutral-200');
                }
            }
        });
    }

    // 2. Filtro de Convidados (Pesquisa em Tempo Real)
    function filterGuests() {
        const input = document.getElementById('search-guest');
        const filter = input.value.toLowerCase();
        const rows = document.getElementsByClassName('guest-row');
        let hasVisible = false;

        for (let i = 0; i < rows.length; i++) {
            const nameCell = rows[i].getElementsByTagName("td")[0];
            if (nameCell) {
                const txtValue = nameCell.textContent || nameCell.innerText;
                if (txtValue.toLowerCase().indexOf(filter) > -1) {
                    rows[i].style.display = "";
                    hasVisible = true;
                } else {
                    rows[i].style.display = "none";
                }
            }
        }

        // Mostra mensagem se não achar ninguém
        document.getElementById('no-results').style.display = hasVisible ? "none" : "block";
    }
</script>
{% endblock %}